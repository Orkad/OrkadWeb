<div class="flex-container">
  <form (submit)="saveExpense()">
    <div class="center">
      <button
        type="button"
        mat-icon-button
        (click)="monthPicker.previousMonth()"
      >
        <mat-icon>chevron_left</mat-icon>
      </button>
      <app-month-picker
        #monthPicker
        [control]="month"
        [max]="currentMonth"
      ></app-month-picker>
      <button
        type="button"
        mat-icon-button
        (click)="monthPicker.nextMonth()"
        [disabled]="!canNextMonth()"
      >
        <mat-icon>chevron_right</mat-icon>
      </button>
    </div>

    <table id="expense-table" mat-table [dataSource]="dataSource">
      <!-- Date Column -->
      <ng-container matColumnDef="date">
        <th mat-header-cell *matHeaderCellDef ngClass="column-date">Date</th>
        <td mat-cell *matCellDef="let expense">
          <span *ngIf="editedRow !== expense">{{
            expense.date | date: "shortDate"
          }}</span>

          <mat-form-field class="date-form-field" *ngIf="editedRow === expense">
            <input
              matInput
              [matDatepicker]="picker"
              [formControl]="addExpenseControls.date"
            />
            <mat-datepicker-toggle
              matSuffix
              [for]="picker"
            ></mat-datepicker-toggle>
            <mat-datepicker #picker></mat-datepicker>
            <mat-error *ngIf="addExpenseControls.date.hasError('required')"
              >Requis</mat-error
            >
          </mat-form-field>
        </td>
      </ng-container>

      <!-- Name Column -->
      <ng-container matColumnDef="name">
        <th mat-header-cell *matHeaderCellDef style="width: 250px">Libellé</th>
        <td mat-cell *matCellDef="let expense">
          <span *ngIf="editedRow !== expense">{{ expense.name }}</span>
          <mat-form-field *ngIf="editedRow === expense" class="full-width">
            <input matInput [formControl]="addExpenseControls.name" />
            <mat-error *ngIf="addExpenseControls.name.hasError('required')"
              >Requis</mat-error
            >
          </mat-form-field>
        </td>
      </ng-container>

      <!-- Amount Column -->
      <ng-container matColumnDef="amount">
        <th
          mat-header-cell
          *matHeaderCellDef
          ngClass="column-currency"
          style="width: 100px"
        >
          Montant
        </th>
        <td mat-cell *matCellDef="let expense" ngClass="column-currency">
          <span *ngIf="editedRow !== expense">{{
            expense.amount | currency: "EUR"
          }}</span>

          <mat-form-field
            *ngIf="editedRow === expense"
            class="amount-form-field"
          >
            <input
              id="amount"
              type="number"
              matInput
              [formControl]="addExpenseControls.amount"
            />
            <mat-error *ngIf="addExpenseControls.amount.hasError('required')"
              >Requis</mat-error
            >
            <mat-error *ngIf="addExpenseControls.amount.hasError('min')"
              >Le montant doit être suppérieur à 0€</mat-error
            >
            <mat-error *ngIf="addExpenseControls.amount.hasError('max')"
              >Le montant doit être inférieur à {{ maxAmount }}€</mat-error
            >
          </mat-form-field>
        </td>
      </ng-container>

      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef></th>
        <td mat-cell *matCellDef="let expense">
          <button
            *ngIf="editedRow !== expense"
            type="button"
            mat-icon-button
            (click)="beginEditExpense(expense)"
            color="primary"
            [disabled]="editedRow"
          >
            <mat-icon>edit</mat-icon>
          </button>
          <button
            *ngIf="editedRow === expense"
            type="submit"
            mat-icon-button
            color="primary"
            [disabled]="!addExpenseFormGroup.valid"
          >
            <mat-icon>save</mat-icon>
          </button>
          <button
            *ngIf="editedRow !== expense"
            type="button"
            mat-icon-button
            (click)="deleteExpense(expense)"
            color="primary"
            [disabled]="editedRow"
          >
            <mat-icon>delete</mat-icon>
          </button>
          <button
            *ngIf="editedRow === expense"
            type="button"
            color="primary"
            mat-icon-button
            (click)="undo()"
          >
            <mat-icon>undo</mat-icon>
          </button>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr
        mat-row
        *matRowDef="let row; columns: displayedColumns"
        [class.edited]="editedRow === row"
      ></tr>
    </table>
    <div *ngIf="!addExpenseFormVisible" class="bottom-table-button">
      <button mat-mini-fab (click)="beginAddExpense()" color="primary">
        <mat-icon>add</mat-icon>
      </button>
    </div>
  </form>
</div>
